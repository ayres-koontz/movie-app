<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <title>Movies</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
          crossorigin="anonymous">
    <link rel="stylesheet" href="movies-app-style.css">

</head>

<body>

<div id="loading">
    <img id="loading-image" src="gif/371%20(1).gif" alt="Loading..."/>
</div>

<header class="container">

    <div class="brand-img">
        <div class="branding">
            <img src="img/pexels-adrien-olichon-3709370.jpg" alt="Movie Theater">
        </div>
        <div>
            <h2 class="title-style">Cinema Critic</h2>
        </div>
    </div>

</header>

<section class="container">

    <div id="contain"></div>

</section>

<section id="addForm" class="container" style="display: none">

    <form>
        <div class="form-group">
            <label for="new-movie">Add New Movie</label>
            <input type="text" class="form-control autocomplete" id="new-movie"
                   placeholder="Movie Name">
        </div>
        <div class="form-group">
            <label for="new-rating">Rating</label>
            <select class="form-control" id="new-rating">
                <option>5</option>
                <option>4</option>
                <option>3</option>
                <option>2</option>
                <option>1</option>
            </select>
        </div>
        <button type="submit" id="submit-new" class="btn btn-style">Submit</button>
    </form>

</section>


<script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
        crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>

<script src="js/movie-app.js"></script>

<script>

    //---------------------------------------------------------------------------------------------
    //Function to populate the movies on the page:
    // ** Added a data-index-number that gets its value from
    //    the movie id so that we can bind it to the delete function.

    function populateMovies() {
        getMovies().then((movies) => {
            let movieHTML = '';
            $('#loading').hide();
            $("#addForm").show();
            movies.forEach(({id, title, rating}) => {
                movieHTML =
                    `<div class="card card-style"><h1>${title}</h1><div class="d-flex row"><p>Rating: ${rating}</p>
                        <div class=""><button type="submit" data-index-number=${id} id="submit-edit" class="btn btn-style">Edit</button>
                        <button type="submit" data-index-number=${id} id="submit-delete" class="btn btn-style">Delete</button></div></div></div>`;
                $('#contain').append(movieHTML)
            })
        })
    }

    populateMovies();
    //-------------------------------------------------------------------------------------------------
    //Adding functionality to the Delete button:
    // *** Because we are adding events to elements that only exist after the promise is returned,
    //     we have to use EVENT DELEGATION. (https://stackoverflow.com/questions/203198/event-binding-on-dynamically-created-elements)

    $(document).on("click", "#submit-delete", function () {
        let movieIndex = $(this).attr("data-index-number");
        let confirmDelete = confirm(`Are you sure you want to delete this movie?`)
        if (confirmDelete) {
            deleteMovie(movieIndex).then(() => {
                $('#contain').empty();// Empties out the contain div so it can be repopulated
                populateMovies();  //repopulates the contain div
            });
        }
    })

    //-------------------------------------------------------------------------------------------------
    // Have to use event delegation here too
    $(document).on("click", "#submit-edit", function (e) {
        e.preventDefault();
        let movieIndex = $(this).attr("data-index-number");
        // console.log(movieIndex);
        let newName = prompt("What is the name of the movie?")
        // console.log(newName);
        let newRating = prompt("Rate the movie 1-5")
        // console.log(newRating);
        let editedData = {id: movieIndex, title: newName, rating: newRating}; // This is to format the user input
        // console.log(editedData)                                            // to fit into the editMovie function
        let confirmEdit = confirm("Are you sure you want to make these changes?");
        if (confirmEdit) {
            editMovie(editedData).then(() => {
                $('#contain').empty();
                populateMovies();
            });

        }
    })

    //-------------------------------------------------------------------------------------------------
    // Adding functionality to the create move form:
    $("#submit-new").click(function (e) {
        e.preventDefault();
        let movieName = $('#new-movie').val();
        console.log(movieName);
        let movieRating = $("#new-rating").val();
        console.log(movieRating);
        let addedMovie = {title: movieName, rating: movieRating};
        addMovie(addedMovie).then(() => {
            $('#contain').empty();
            populateMovies();
        });
    })

</script>

</body>
</html>